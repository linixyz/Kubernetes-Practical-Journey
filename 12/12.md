# 通过iptable追踪Kubernetes网络

Kubernetes 使用 iptables 处理许多网络和端口转发规则，在本文中，我们将通过跟踪 HTTP 请求到 Kubernetes 集群上运行的服务的过程，以此了解 Kubernetes 网络、数据流向、转发规则。

## 1. 查看 kube-proxy 端口

默认端口

1. 10249 metrics port
2. 10256 healthz port

```bash
netstat -lnpt|grep kube-proxy
tcp        0      0 127.0.0.1:10249         0.0.0.0:*               LISTEN      30719/kube-proxy
```

## 2. 确认 kube-proxy 模式

kube-proxy 在每个节点上运行，所以可以在集群中任意节点访问。

```bash
curl 127.0.0.1:10249/proxyMode
```

如果你的 kube-proxy 运行在 iptable 模式上，则可以通过以下方法对网络进行追踪，反之则不行。

## 3. 载入内核netfilter模块

> 维基百科：Netfilter是在[Linux内核](https://zh.wikipedia.org/wiki/Linux內核)中的一个[软件框架](https://zh.wikipedia.org/wiki/軟體框架)，用于管理网络数据包。不仅具有[网络地址转换](https://zh.wikipedia.org/wiki/网络地址转换)（NAT）的功能，也具备数据包内容修改、以及数据包过滤等[防火墙](https://zh.wikipedia.org/wiki/防火墙)功能。利用运作于[用户空间](https://zh.wikipedia.org/wiki/使用者空間)的应用软件，如[iptables](https://zh.wikipedia.org/wiki/Iptables)、[ebtables](https://zh.wikipedia.org/w/index.php?title=Ebtables&action=edit&redlink=1)和[arptables](https://zh.wikipedia.org/wiki/Arptables)等，来控制Netfilter，系统管理者可以管理通过Linux操作系统的各种网络数据包。

进行日志记录需要使用 `ipt_LOG` 、`nf_log_ipv4` 或 `ip6t_LOG` 模块，详情可以通过 `man iptables-extensions`查看trace模块说明，不同linux发行版需要的模块可能不同（例如：CentOS6 使用 ipt_LOG 模块，CentOS7、Ubuntu18 使用 nf_log_ipv4 模块），由于我的环境是 Ubuntu 18.04，并且需要跟踪IPV4数据包，所以我需要加载 nf_log_ipv4 模块；

```bash
modprobe nf_log_ipv4
sysctl net.netfilter.nf_log.2=nf_log_ipv4
systemctl restart rsyslog
```

## 4. 定义 Iptable 追踪规则

追踪 `raw` 表，协议`tcp`，端口`32741`, 规则链`PREROUTING`和`OUTPUT`, `TRACE` 模块将匹配的数据包记录至后端日志中，最后的1为规则`num`（如果已有规则中编号1已存在，则将新规则插入编号1前，并将新规则后面所有规则编号`+1`）。

```
iptables -t raw -j TRACE -p tcp --dport 32275 -I OUTPUT 1
iptables -t raw -j TRACE -p tcp --dport 32275 -I PREROUTING 1
 
iptables -t raw -j TRACE -p tcp -I OUTPUT 1
iptables -t raw -j TRACE -p tcp -I PREROUTING 1
```

## 5. 查看日志文件

不同Linux发行版，日志文件不同

1. /var/log/messages
2. /var/log/syslog
3. /var/log/kern.log

```bash
tail -n 100 /var/log/syslog
```

## 6. 查看所有Iptable规则

```bash
iptables-save
```

## 7. 示例Trace日志

```
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398739] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398752] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398768] TRACE: nat:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398788] TRACE: nat:KUBE-SERVICES:rule:23 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398795] TRACE: nat:KUBE-NODEPORTS:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398807] TRACE: nat:KUBE-XLB-XP7QDA4CRQ2QA33W:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398813] TRACE: nat:KUBE-MARK-MASQ:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398820] TRACE: nat:KUBE-MARK-MASQ:return:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398830] TRACE: nat:KUBE-XLB-XP7QDA4CRQ2QA33W:rule:3 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398839] TRACE: nat:KUBE-SVC-XP7QDA4CRQ2QA33W:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398847] TRACE: nat:KUBE-SEP-YO2DYWAEPAUV7YLG:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398867] TRACE: filter:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398875] TRACE: filter:KUBE-SERVICES:return:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398881] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398887] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398893] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398899] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398905] TRACE: nat:POSTROUTING:rule:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:30 kubernetes-master kernel: [2615776.398911] TRACE: nat:KUBE-POSTROUTING:rule:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422483] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422497] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422518] TRACE: filter:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422526] TRACE: filter:KUBE-SERVICES:return:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422532] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422539] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422544] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422550] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422917] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422925] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422933] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422939] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422944] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.422949] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423022] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423032] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423043] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423049] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423054] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423060] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423914] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423920] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423935] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423941] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423946] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.423951] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38064 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AB06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424097] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424105] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424113] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424119] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424125] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424130] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38065 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696961 ACK=2772748087 WINDOW=350 RES=0x00 ACK FIN URGP=0 OPT (0101080A781D52AC06A71075) UID=1000 GID=1000
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424325] TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424331] TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424339] TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424345] TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424350] TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
Jul  5 14:02:31 kubernetes-master kernel: [2615777.424355] TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38066 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696962 ACK=2772748088 WINDOW=350 RES=0x00 ACK URGP=0 OPT (0101080A781D52AC06A71076)
```

## 8. 示例Iptable规则

```
# Generated by iptables-save v1.6.1 on Sun Jul  5 14:06:13 2020
*raw
:PREROUTING ACCEPT [2748:519307]
:OUTPUT ACCEPT [2737:592288]
COMMIT
# Completed on Sun Jul  5 14:06:13 2020
# Generated by iptables-save v1.6.1 on Sun Jul  5 14:06:13 2020
*mangle
:PREROUTING ACCEPT [343985513:65742282264]
:INPUT ACCEPT [343876299:65731400986]
:FORWARD ACCEPT [4:490]
:OUTPUT ACCEPT [345191335:73682983506]
:POSTROUTING ACCEPT [345191339:73682983996]
:KUBE-KUBELET-CANARY - [0:0]
:KUBE-PROXY-CANARY - [0:0]
COMMIT
# Completed on Sun Jul  5 14:06:13 2020
# Generated by iptables-save v1.6.1 on Sun Jul  5 14:06:13 2020
*filter
:INPUT ACCEPT [475211:93164411]
:FORWARD DROP [0:0]
:OUTPUT ACCEPT [477071:107150258]
:DOCKER - [0:0]
:DOCKER-ISOLATION-STAGE-1 - [0:0]
:DOCKER-ISOLATION-STAGE-2 - [0:0]
:DOCKER-USER - [0:0]
:KUBE-EXTERNAL-SERVICES - [0:0]
:KUBE-FIREWALL - [0:0]
:KUBE-FORWARD - [0:0]
:KUBE-KUBELET-CANARY - [0:0]
:KUBE-PROXY-CANARY - [0:0]
:KUBE-SERVICES - [0:0]
-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A INPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes externally-visible service portals" -j KUBE-EXTERNAL-SERVICES
-A INPUT -j KUBE-FIREWALL
-A FORWARD -m comment --comment "kubernetes forwarding rules" -j KUBE-FORWARD
-A FORWARD -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A FORWARD -j DOCKER-USER
-A FORWARD -j DOCKER-ISOLATION-STAGE-1
-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -o docker0 -j DOCKER
-A FORWARD -i docker0 ! -o docker0 -j ACCEPT
-A FORWARD -i docker0 -o docker0 -j ACCEPT
-A FORWARD -s 10.244.0.0/16 -j ACCEPT
-A FORWARD -d 10.244.0.0/16 -j ACCEPT
-A OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT -j KUBE-FIREWALL
-A DOCKER-ISOLATION-STAGE-1 -i docker0 ! -o docker0 -j DOCKER-ISOLATION-STAGE-2
-A DOCKER-ISOLATION-STAGE-1 -j RETURN
-A DOCKER-ISOLATION-STAGE-2 -o docker0 -j DROP
-A DOCKER-ISOLATION-STAGE-2 -j RETURN
-A DOCKER-USER -j RETURN
-A KUBE-FIREWALL -m comment --comment "kubernetes firewall for dropping marked packets" -m mark --mark 0x8000/0x8000 -j DROP
-A KUBE-FORWARD -m conntrack --ctstate INVALID -j DROP
-A KUBE-FORWARD -m comment --comment "kubernetes forwarding rules" -m mark --mark 0x4000/0x4000 -j ACCEPT
-A KUBE-FORWARD -m comment --comment "kubernetes forwarding conntrack pod source rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A KUBE-FORWARD -m comment --comment "kubernetes forwarding conntrack pod destination rule" -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Sun Jul  5 14:06:13 2020
# Generated by iptables-save v1.6.1 on Sun Jul  5 14:06:13 2020
*nat
:PREROUTING ACCEPT [130:27663]
:INPUT ACCEPT [130:27663]
:OUTPUT ACCEPT [2565:187248]
:POSTROUTING ACCEPT [2564:187138]
:DOCKER - [0:0]
:KUBE-KUBELET-CANARY - [0:0]
:KUBE-MARK-DROP - [0:0]
:KUBE-MARK-MASQ - [0:0]
:KUBE-NODEPORTS - [0:0]
:KUBE-POSTROUTING - [0:0]
:KUBE-PROXY-CANARY - [0:0]
:KUBE-SEP-6E7XQMQ4RAYOWTTM - [0:0]
:KUBE-SEP-B62KF62NADDHRLDD - [0:0]
:KUBE-SEP-CGQ4WNI5FSRTITNN - [0:0]
:KUBE-SEP-IT2ZTR26TO4XFPTO - [0:0]
:KUBE-SEP-K44XY3UTO2AXHREB - [0:0]
:KUBE-SEP-N4G2XR5TDX7PQE7P - [0:0]
:KUBE-SEP-NQGKFEKLZ6NHJV7F - [0:0]
:KUBE-SEP-PNULLKADU5ZE6ABS - [0:0]
:KUBE-SEP-VUQT4CVSAQEYZ4EZ - [0:0]
:KUBE-SEP-WU4GLC6EQTIBMMOV - [0:0]
:KUBE-SEP-YIL6JZP7A3QYXJU2 - [0:0]
:KUBE-SEP-YO2DYWAEPAUV7YLG - [0:0]
:KUBE-SEP-ZP3FB6NMPNCO4VBJ - [0:0]
:KUBE-SEP-ZXMNUKOKXUTL2MK2 - [0:0]
:KUBE-SERVICES - [0:0]
:KUBE-SVC-4CRUJHTV5RT5YMFY - [0:0]
:KUBE-SVC-7Z2ZUTFX6CD3TBT2 - [0:0]
:KUBE-SVC-CQNAS6RSUGJF2C2D - [0:0]
:KUBE-SVC-EBUCVM6MLPBS53NX - [0:0]
:KUBE-SVC-ERIFXISQEP7F7OF4 - [0:0]
:KUBE-SVC-J3BEA7WOARFSAXTQ - [0:0]
:KUBE-SVC-JD5MR3NA4I4DYORP - [0:0]
:KUBE-SVC-NDSMHFCKXJRPU4FV - [0:0]
:KUBE-SVC-NPX46M4PTMTKRN6Y - [0:0]
:KUBE-SVC-TCOU7JCQXEZGVUNU - [0:0]
:KUBE-SVC-XP7QDA4CRQ2QA33W - [0:0]
:KUBE-XLB-XP7QDA4CRQ2QA33W - [0:0]
-A PREROUTING -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -m comment --comment "kubernetes postrouting rules" -j KUBE-POSTROUTING
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A POSTROUTING -s 10.244.0.0/16 -d 10.244.0.0/16 -j RETURN
-A POSTROUTING -s 10.244.0.0/16 ! -d 224.0.0.0/4 -j MASQUERADE
-A POSTROUTING ! -s 10.244.0.0/16 -d 10.244.0.0/24 -j RETURN
-A POSTROUTING ! -s 10.244.0.0/16 -d 10.244.0.0/16 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000
-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
-A KUBE-NODEPORTS -s 127.0.0.0/8 -p tcp -m comment --comment "default/nodeport:" -m tcp --dport 32275 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/nodeport:" -m tcp --dport 32275 -j KUBE-XLB-XP7QDA4CRQ2QA33W
-A KUBE-NODEPORTS -p tcp -m comment --comment "nginx-ingress/nginx-ingress:http" -m tcp --dport 32726 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "nginx-ingress/nginx-ingress:http" -m tcp --dport 32726 -j KUBE-SVC-EBUCVM6MLPBS53NX
-A KUBE-NODEPORTS -p tcp -m comment --comment "nginx-ingress/nginx-ingress:https" -m tcp --dport 32466 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "nginx-ingress/nginx-ingress:https" -m tcp --dport 32466 -j KUBE-SVC-7Z2ZUTFX6CD3TBT2
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/loadbalancer:" -m tcp --dport 30504 -j KUBE-MARK-MASQ
-A KUBE-NODEPORTS -p tcp -m comment --comment "default/loadbalancer:" -m tcp --dport 30504 -j KUBE-SVC-J3BEA7WOARFSAXTQ
-A KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE
-A KUBE-SEP-6E7XQMQ4RAYOWTTM -s 10.244.0.3/32 -m comment --comment "kube-system/kube-dns:dns" -j KUBE-MARK-MASQ
-A KUBE-SEP-6E7XQMQ4RAYOWTTM -p udp -m comment --comment "kube-system/kube-dns:dns" -m udp -j DNAT --to-destination 10.244.0.3:53
-A KUBE-SEP-B62KF62NADDHRLDD -s 10.244.2.3/32 -m comment --comment "nginx-ingress/nginx-ingress:http" -j KUBE-MARK-MASQ
-A KUBE-SEP-B62KF62NADDHRLDD -p tcp -m comment --comment "nginx-ingress/nginx-ingress:http" -m tcp -j DNAT --to-destination 10.244.2.3:80
-A KUBE-SEP-CGQ4WNI5FSRTITNN -s 10.244.3.5/32 -m comment --comment "kubernetes-dashboard/dashboard-metrics-scraper:" -j KUBE-MARK-MASQ
-A KUBE-SEP-CGQ4WNI5FSRTITNN -p tcp -m comment --comment "kubernetes-dashboard/dashboard-metrics-scraper:" -m tcp -j DNAT --to-destination 10.244.3.5:8000
-A KUBE-SEP-IT2ZTR26TO4XFPTO -s 10.244.0.2/32 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-MARK-MASQ
-A KUBE-SEP-IT2ZTR26TO4XFPTO -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp" -m tcp -j DNAT --to-destination 10.244.0.2:53
-A KUBE-SEP-K44XY3UTO2AXHREB -s 10.244.3.3/32 -m comment --comment "default/loadbalancer:" -j KUBE-MARK-MASQ
-A KUBE-SEP-K44XY3UTO2AXHREB -p tcp -m comment --comment "default/loadbalancer:" -m tcp -j DNAT --to-destination 10.244.3.3:8080
-A KUBE-SEP-N4G2XR5TDX7PQE7P -s 10.244.0.2/32 -m comment --comment "kube-system/kube-dns:metrics" -j KUBE-MARK-MASQ
-A KUBE-SEP-N4G2XR5TDX7PQE7P -p tcp -m comment --comment "kube-system/kube-dns:metrics" -m tcp -j DNAT --to-destination 10.244.0.2:9153
-A KUBE-SEP-NQGKFEKLZ6NHJV7F -s 10.244.2.3/32 -m comment --comment "nginx-ingress/nginx-ingress:https" -j KUBE-MARK-MASQ
-A KUBE-SEP-NQGKFEKLZ6NHJV7F -p tcp -m comment --comment "nginx-ingress/nginx-ingress:https" -m tcp -j DNAT --to-destination 10.244.2.3:443
-A KUBE-SEP-PNULLKADU5ZE6ABS -s 192.168.199.34/32 -m comment --comment "default/kubernetes:https" -j KUBE-MARK-MASQ
-A KUBE-SEP-PNULLKADU5ZE6ABS -p tcp -m comment --comment "default/kubernetes:https" -m tcp -j DNAT --to-destination 192.168.199.34:6443
-A KUBE-SEP-VUQT4CVSAQEYZ4EZ -s 10.244.3.3/32 -m comment --comment "default/clusterip:" -j KUBE-MARK-MASQ
-A KUBE-SEP-VUQT4CVSAQEYZ4EZ -p tcp -m comment --comment "default/clusterip:" -m tcp -j DNAT --to-destination 10.244.3.3:8080
-A KUBE-SEP-WU4GLC6EQTIBMMOV -s 10.244.3.4/32 -m comment --comment "kubernetes-dashboard/kubernetes-dashboard:" -j KUBE-MARK-MASQ
-A KUBE-SEP-WU4GLC6EQTIBMMOV -p tcp -m comment --comment "kubernetes-dashboard/kubernetes-dashboard:" -m tcp -j DNAT --to-destination 10.244.3.4:8443
-A KUBE-SEP-YIL6JZP7A3QYXJU2 -s 10.244.0.2/32 -m comment --comment "kube-system/kube-dns:dns" -j KUBE-MARK-MASQ
-A KUBE-SEP-YIL6JZP7A3QYXJU2 -p udp -m comment --comment "kube-system/kube-dns:dns" -m udp -j DNAT --to-destination 10.244.0.2:53
-A KUBE-SEP-YO2DYWAEPAUV7YLG -s 10.244.3.3/32 -m comment --comment "default/nodeport:" -j KUBE-MARK-MASQ
-A KUBE-SEP-YO2DYWAEPAUV7YLG -p tcp -m comment --comment "default/nodeport:" -m tcp -j DNAT --to-destination 10.244.3.3:8080
-A KUBE-SEP-ZP3FB6NMPNCO4VBJ -s 10.244.0.3/32 -m comment --comment "kube-system/kube-dns:metrics" -j KUBE-MARK-MASQ
-A KUBE-SEP-ZP3FB6NMPNCO4VBJ -p tcp -m comment --comment "kube-system/kube-dns:metrics" -m tcp -j DNAT --to-destination 10.244.0.3:9153
-A KUBE-SEP-ZXMNUKOKXUTL2MK2 -s 10.244.0.3/32 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-MARK-MASQ
-A KUBE-SEP-ZXMNUKOKXUTL2MK2 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp" -m tcp -j DNAT --to-destination 10.244.0.3:53
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.108.221.186/32 -p tcp -m comment --comment "kubernetes-dashboard/dashboard-metrics-scraper: cluster IP" -m tcp --dport 8000 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.108.221.186/32 -p tcp -m comment --comment "kubernetes-dashboard/dashboard-metrics-scraper: cluster IP" -m tcp --dport 8000 -j KUBE-SVC-NDSMHFCKXJRPU4FV
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.96.0.10/32 -p tcp -m comment --comment "kube-system/kube-dns:metrics cluster IP" -m tcp --dport 9153 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.0.10/32 -p tcp -m comment --comment "kube-system/kube-dns:metrics cluster IP" -m tcp --dport 9153 -j KUBE-SVC-JD5MR3NA4I4DYORP
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.96.0.10/32 -p udp -m comment --comment "kube-system/kube-dns:dns cluster IP" -m udp --dport 53 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.0.10/32 -p udp -m comment --comment "kube-system/kube-dns:dns cluster IP" -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.105.30.187/32 -p tcp -m comment --comment "default/clusterip: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.105.30.187/32 -p tcp -m comment --comment "default/clusterip: cluster IP" -m tcp --dport 80 -j KUBE-SVC-CQNAS6RSUGJF2C2D
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.106.13.14/32 -p tcp -m comment --comment "default/nodeport: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.106.13.14/32 -p tcp -m comment --comment "default/nodeport: cluster IP" -m tcp --dport 80 -j KUBE-SVC-XP7QDA4CRQ2QA33W
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.105.97.243/32 -p tcp -m comment --comment "kubernetes-dashboard/kubernetes-dashboard: cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.105.97.243/32 -p tcp -m comment --comment "kubernetes-dashboard/kubernetes-dashboard: cluster IP" -m tcp --dport 443 -j KUBE-SVC-4CRUJHTV5RT5YMFY
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.96.0.1/32 -p tcp -m comment --comment "default/kubernetes:https cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.0.1/32 -p tcp -m comment --comment "default/kubernetes:https cluster IP" -m tcp --dport 443 -j KUBE-SVC-NPX46M4PTMTKRN6Y
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.96.0.10/32 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp cluster IP" -m tcp --dport 53 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.96.0.10/32 -p tcp -m comment --comment "kube-system/kube-dns:dns-tcp cluster IP" -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.106.210.225/32 -p tcp -m comment --comment "nginx-ingress/nginx-ingress:http cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.106.210.225/32 -p tcp -m comment --comment "nginx-ingress/nginx-ingress:http cluster IP" -m tcp --dport 80 -j KUBE-SVC-EBUCVM6MLPBS53NX
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.106.210.225/32 -p tcp -m comment --comment "nginx-ingress/nginx-ingress:https cluster IP" -m tcp --dport 443 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.106.210.225/32 -p tcp -m comment --comment "nginx-ingress/nginx-ingress:https cluster IP" -m tcp --dport 443 -j KUBE-SVC-7Z2ZUTFX6CD3TBT2
-A KUBE-SERVICES ! -s 10.244.0.0/16 -d 10.107.100.85/32 -p tcp -m comment --comment "default/loadbalancer: cluster IP" -m tcp --dport 80 -j KUBE-MARK-MASQ
-A KUBE-SERVICES -d 10.107.100.85/32 -p tcp -m comment --comment "default/loadbalancer: cluster IP" -m tcp --dport 80 -j KUBE-SVC-J3BEA7WOARFSAXTQ
-A KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
-A KUBE-SVC-4CRUJHTV5RT5YMFY -m comment --comment "kubernetes-dashboard/kubernetes-dashboard:" -j KUBE-SEP-WU4GLC6EQTIBMMOV
-A KUBE-SVC-7Z2ZUTFX6CD3TBT2 -m comment --comment "nginx-ingress/nginx-ingress:https" -j KUBE-SEP-NQGKFEKLZ6NHJV7F
-A KUBE-SVC-CQNAS6RSUGJF2C2D -m comment --comment "default/clusterip:" -j KUBE-SEP-VUQT4CVSAQEYZ4EZ
-A KUBE-SVC-EBUCVM6MLPBS53NX -m comment --comment "nginx-ingress/nginx-ingress:http" -j KUBE-SEP-B62KF62NADDHRLDD
-A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment "kube-system/kube-dns:dns-tcp" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-IT2ZTR26TO4XFPTO
-A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment "kube-system/kube-dns:dns-tcp" -j KUBE-SEP-ZXMNUKOKXUTL2MK2
-A KUBE-SVC-J3BEA7WOARFSAXTQ -m comment --comment "default/loadbalancer:" -j KUBE-SEP-K44XY3UTO2AXHREB
-A KUBE-SVC-JD5MR3NA4I4DYORP -m comment --comment "kube-system/kube-dns:metrics" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-N4G2XR5TDX7PQE7P
-A KUBE-SVC-JD5MR3NA4I4DYORP -m comment --comment "kube-system/kube-dns:metrics" -j KUBE-SEP-ZP3FB6NMPNCO4VBJ
-A KUBE-SVC-NDSMHFCKXJRPU4FV -m comment --comment "kubernetes-dashboard/dashboard-metrics-scraper:" -j KUBE-SEP-CGQ4WNI5FSRTITNN
-A KUBE-SVC-NPX46M4PTMTKRN6Y -m comment --comment "default/kubernetes:https" -j KUBE-SEP-PNULLKADU5ZE6ABS
-A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment "kube-system/kube-dns:dns" -m statistic --mode random --probability 0.50000000000 -j KUBE-SEP-YIL6JZP7A3QYXJU2
-A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment "kube-system/kube-dns:dns" -j KUBE-SEP-6E7XQMQ4RAYOWTTM
-A KUBE-SVC-XP7QDA4CRQ2QA33W -m comment --comment "default/nodeport:" -j KUBE-SEP-YO2DYWAEPAUV7YLG
-A KUBE-XLB-XP7QDA4CRQ2QA33W -s 10.244.0.0/16 -m comment --comment "Redirect pods trying to reach external loadbalancer VIP to clusterIP" -j KUBE-SVC-XP7QDA4CRQ2QA33W
-A KUBE-XLB-XP7QDA4CRQ2QA33W -m comment --comment "masquerade LOCAL traffic for default/nodeport: LB IP" -m addrtype --src-type LOCAL -j KUBE-MARK-MASQ
-A KUBE-XLB-XP7QDA4CRQ2QA33W -m comment --comment "route LOCAL traffic for default/nodeport: LB IP to service chain" -m addrtype --src-type LOCAL -j KUBE-SVC-XP7QDA4CRQ2QA33W
-A KUBE-XLB-XP7QDA4CRQ2QA33W -m comment --comment "default/nodeport: has no local endpoints" -j KUBE-MARK-DROP
COMMIT
```

## 9. 示例日志分析

示例日志包含了一个完整的TCP建立连接、发送数据、关闭连接，下面将逐块分析57行示例日志，其中因为我们手工在`raw`表`OUTPUT`和`PREROUTING`链中添加了两条规则，所以分析日志时，会选择性忽略我们添加的那两调规则。

### 9.1 建立连接前

```
日志：nat:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
规则：OUTPUT -m conntrack --ctstate NEW -m comment --comment "kubernetes service portals" -j KUBE-SERVICES
```

在`Master`节点上访问`nodeport service`时 （`curl -s 192.168.199.34:32275`），iptables 匹配到的第一条规则就是做一个重定向，将网络请求转发至`KUBE-SERVICES`链上。

```
日志：TRACE: nat:KUBE-SERVICES:rule:23 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
规则：KUBE-SERVICES -m comment --comment "kubernetes service nodeports; NOTE: this must be the last rule in this chain" -m addrtype --dst-type LOCAL -j KUBE-NODEPORTS
```

由`KUBE-SERVICES`链匹配第23条规则，将网络请求转发至`KUBE-NODEPORTS`链。

```
日志：TRACE: nat:KUBE-NODEPORTS:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
规则：KUBE-NODEPORTS -p tcp -m comment --comment "default/nodeport:" -m tcp --dport 32275 -j KUBE-XLB-XP7QDA4CRQ2QA33W
```

由`KUBE-NODEPORTS`链匹配第2条规则，将网络请求转发至`KUBE-XLB-XXX`链。

```
日志：TRACE: nat:KUBE-XLB-XP7QDA4CRQ2QA33W:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
规则：KUBE-XLB-XP7QDA4CRQ2QA33W -s 10.244.0.0/16 -m comment --comment "Redirect pods trying to reach external loadbalancer VIP to clusterIP" -j KUBE-SVC-XP7QDA4CRQ2QA33W
```

由`KUBE-XLB-XP7QDA4CRQ2QA33W`链匹配第2条规则，并且将目标重定向至 `10.244.0.0/16` 集群内部虚拟IP上，规则最后目标依旧是`KUBE-XLB-XP7QDA4CRQ2QA33W`，由于我们是根据协议+端口匹配规则日志，所以这里补上日志中遗漏的规则匹配：

```
规则：KUBE-XLB-XP7QDA4CRQ2QA33W -m comment --comment "masquerade LOCAL traffic for default/nodeport: LB IP" -m addrtype --src-type LOCAL -j KUBE-MARK-MASQ
```

在`Iptables`模式下，`kubernetes`会为每个`service`创建`KUBE-XLB-XXX`、`KUBE-SVC-XXX`链，感兴趣的同学可查看上方完整的`Iptables`规则。

```
日志：TRACE: nat:KUBE-MARK-MASQ:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000
规则：KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000
 
日志：TRACE: nat:KUBE-MARK-MASQ:return:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
日志：TRACE: nat:KUBE-XLB-XP7QDA4CRQ2QA33W:rule:3 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
```

使用 `Iptables`的`MARK`为当前数据包打上`0x4000`标签，可以看到该条日志后面的日志最后均有`MARK=0x4000`标记，被打上该标记的数据包会进行`SNAT`。

```
日志：TRACE: nat:KUBE-SVC-XP7QDA4CRQ2QA33W:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
规则：KUBE-SVC-XP7QDA4CRQ2QA33W -m comment --comment "default/nodeport:" -j KUBE-SEP-YO2DYWAEPAUV7YLG
```

与本条规则与之对应的还有另一条规则：

```
KUBE-XLB-XP7QDA4CRQ2QA33W -m comment --comment "default/nodeport: has no local endpoints" -j KUBE-MARK-DROP
```

通过注释不难看出，当`spec.externalTrafficPolic`为`Locl`时，如果本地没有`endpoint`，将会匹配这条规则。

```
日志：TRACE: nat:KUBE-SEP-YO2DYWAEPAUV7YLG:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
规则：KUBE-SEP-YO2DYWAEPAUV7YLG -p tcp -m comment --comment "default/nodeport:" -m tcp -j DNAT --to-destination 10.244.3.3:8080
```

由`KUBE-SEP-YO2DYWAEPAUV7YLG`链第2条规则，对数据包进行`DNAT`，将数据包中的目的地IP改为集群內对应Pod IP，从本条日志向下看时，可以发现日志中的DST已变为Pod IP。

### 9.2 建立连接

```
TRACE: filter:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: filter:KUBE-SERVICES:return:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: nat:POSTROUTING:rule:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
TRACE: nat:KUBE-POSTROUTING:rule:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38060 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D4EAA0000000001030307) UID=1000 GID=1000 MARK=0x4000
 
规则：KUBE-POSTROUTING -m comment --comment "kubernetes service traffic requiring SNAT" -m mark --mark 0x4000/0x4000 -j MASQUERADE
```

经过几次数据包过滤后，跳转至`nat:POSTROUTING`再跳转至`nat:KUBE-POSTROUTING`，`KUBE-POSTROUTING`只做了一件事就是使用`MASQUERADE`对打了`0x4000`标记的数据包做`SNAT`（将数据包的来源IP改为宿主机IP，也就是节点IP），到这里从`Master宿主机`访问`Pod`的流程就结束了。

```
TRACE: filter:OUTPUT:rule:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
TRACE: filter:KUBE-SERVICES:return:1 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=60 TOS=0x00 PREC=0x00 TTL=64 ID=38061 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696876 ACK=0 WINDOW=43690 RES=0x00 SYN URGP=0 OPT (0204FFD70402080A781D52AA0000000001030307) UID=1000 GID=1000
 
TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=38062 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK URGP=0 OPT (0101080A781D52AA06A71074) UID=1000 GID=1000
```

这里看到的是TCP三次握手中的客户端视角，一次 SYN，一次 ACK，至此连接建立。

### 9.3 数据传输

```
TRACE: raw:OUTPUT:policy:2 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
TRACE: mangle:OUTPUT:policy:1 IN= OUT=lo SRC=192.168.199.34 DST=192.168.199.34 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=32275 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
TRACE: filter:OUTPUT:rule:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
TRACE: filter:KUBE-FIREWALL:return:2 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
TRACE: filter:OUTPUT:policy:3 IN= OUT=lo SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
TRACE: mangle:POSTROUTING:policy:1 IN= OUT=flannel.1 SRC=192.168.199.34 DST=10.244.3.3 LEN=136 TOS=0x00 PREC=0x00 TTL=64 ID=38063 DF PROTO=TCP SPT=44522 DPT=8080 SEQ=3110696877 ACK=2772747535 WINDOW=342 RES=0x00 ACK PSH URGP=0 OPT (0101080A781D52AB06A71074) UID=1000 GID=1000
```

通过上面6行日志，`PSH` 位为1，判断此时有数据传输。